(function () {

    angular.module('meanApp', ['ui.bootstrap', 'ngRoute']);

    function config ($routeProvider, $locationProvider) {
        $routeProvider
            .when('/', {
                templateUrl: '/home/home.view.html',
                controller: 'homeCtrl',
            })
            .when('/register', {
                templateUrl: '/authentication/register/register.view.html',
                controller: 'registerCtrl',
            })
            .when('/login', {
                templateUrl: '/authentication/login/login.view.html',
                controller: 'loginCtrl',
            })
            .when('/message', {
                templateUrl: '/profile/messages/messages.view.html',
                controller: 'messageCtrl',
            })
            .when('/profile/:id', {
                templateUrl: '/profile/profile/profile.view.html',
                controller: 'profileCtrl',
            })
            .when('/profile', {
                templateUrl: '/profile/profile/profile.view.html',
                controller: 'profileCtrl',
            })
            .when('/settings', {
                templateUrl: '/profile/settings/settings.view.html',
                controller: 'settingsCtrl',
            })
            .otherwise({redirectTo: '/'});

        // use the HTML5 History API
        $locationProvider.html5Mode(true);
    }

    //TODO: update this to handle other things non logged in people shouldn't see
    function run($rootScope, $location, authentication) {
        $rootScope.$on('$routeChangeStart', function(event, nextRoute, currentRoute) {
            if ($location.path() === '/profile' && !authentication.isLoggedIn()) {
                $location.path('/');
            }
        });
    }

    angular
        .module('meanApp')
        .config(['$routeProvider', '$locationProvider', config])
        .run(['$rootScope', '$location', 'authentication', run]);

})();
(function() {

    angular
        .module('meanApp')
        .controller('homeCtrl', homeCtrl);

    function homeCtrl () {
    }

})();
(function () {

    angular
        .module('meanApp')
        .controller('loginCtrl', loginCtrl);

    loginCtrl.$inject = ['$location', '$scope', 'authentication'];
    function loginCtrl($location, $scope, authentication) {

        $scope.credentials = {
            email : "",
            password : ""
        };

        $scope.onSubmit = function () {
            authentication
                .login($scope.credentials)
                .error(function(err){
                    alert(err.message);
                })
                .then(function(){
                    $location.path('/');
                });
        };

    }

})();
(function () {

    angular
        .module('meanApp')
        .controller('registerCtrl', registerCtrl);

    registerCtrl.$inject = ['$location', '$scope', 'authentication'];
    function registerCtrl($location, $scope, authentication) {

        $scope.errorPresent = false;
        $scope.errorMsg = [];

        $scope.credentials = {
            username: "",
            email : "",
            password : "",
            confirmPass : ""
        };


        var onError = function (err) {
            console.log('Registration failed due to incorrect field values');
            $scope.errorPresent = true;
            $scope.errorMsg = err.errorMessage;
        };
        
        $scope.onSubmit = function () {
            console.log('Checking registration...');

            authentication
                .register($scope.credentials)
                .error(onError)
                .then(function () {
                    $location.path('profile');
                    console.log('Submitting registration');
                });
        };

    }

})();
(function () {

    angular
        .module('meanApp')
        .service('authentication', authentication);

    authentication.$inject = ['$http', '$window'];
    function authentication ($http, $window) {

        var saveToken = function (token) {
            $window.localStorage['token'] = token;
        };

        var getToken = function () {
            return $window.localStorage['token'];
        };

        var isLoggedIn = function() {
            var token = getToken();
            var payload;

            if(token){
                payload = token.split('.')[1];
                payload = $window.atob(payload);
                payload = JSON.parse(payload);

                return payload.exp > Date.now() / 1000;
            } else {
                return false;
            }
        };

        var currentUser = function() {
            if(isLoggedIn()){
                var token = getToken();
                var payload = token.split('.')[1];
                payload = $window.atob(payload);
                payload = JSON.parse(payload);
                return {
                    email : payload.email,
                    name : payload.username
                };
            }
        };

        var register = function(user) {
            return $http.post('/api/register', user).success(function(data){
                saveToken(data.token);
            });
        };

        var login = function(user) {
            return $http.post('/api/login', user).success(function(data) {
                saveToken(data.token);
            });
        };

        var logout = function() {
            $window.localStorage.removeItem('token');
        };

        return {
            currentUser : currentUser,
            saveToken : saveToken,
            getToken : getToken,
            isLoggedIn : isLoggedIn,
            register : register,
            login : login,
            logout : logout
        };
    }

})();
(function() {

    angular
        .module('meanApp')
        .service('meanData', meanData);

    meanData.$inject = ['$http', 'authentication'];
    function meanData ($http, authentication) {

        var getProfile = function () {
            return $http.get('/api/profile', {
                headers: {
                    Authorization: 'Bearer '+ authentication.getToken()
                }
            });
        };

        var getProfileById = function(id){
            var url = '/api/profile/' + id;
            return $http.get(url);
        };

        var sendMessage = function(sender, receiver, message) {
            var date = new Date();
            var url = '/api/message/' + receiver;
            var request = {
                sender : sender,
                dateSent : date,
                message : message
            };
            return $http.post(url, request);
        };

        var deleteMessage = function (user, id) {
            var url = 'api/delete-message/' + user;
            return $http.post(url, {id : id});
        };
        
        var addFriend = function (sender, receiver) {
            var url = 'api/friend/' + receiver;
            return $http.post(url, {sender : sender});
        };
        
        var acceptFriend = function (sender, receiver) {
            var url = 'api/accept-friend/' + receiver;
            return $http.post(url, {sender : sender});
        };

        var rejectFriend = function (sender, receiver) {
            var url = 'api/reject-friend/' + receiver;
            return $http.post(url, {sender : sender});
        };

        var deleteFriend = function (sender, receiver) {
            var url = 'api/delete-friend/' + receiver;
            return $http.post(url, {sender : sender});
        };

        var changePassword = function (passwords) {
            return $http.post('api/settings/password', passwords);
        };

        var changeEmail = function (user) {
            return $http.post('api/settings/email', user);
        };

        var changeProfilePic = function (user) {
            return $http.post('api/settings/profilePic', user);
        };

        return {
            getProfile : getProfile,
            getProfileById : getProfileById,
            sendMessage : sendMessage,
            deleteMessage : deleteMessage,
            addFriend : addFriend,
            acceptFriend : acceptFriend,
            rejectFriend : rejectFriend,
            deleteFriend : deleteFriend,
            changePassword : changePassword,
            changeEmail : changeEmail,
            changeProfilePic : changeProfilePic
        };
    }

})();
(function () {

    angular
        .module('meanApp')
        .controller('messageCtrl', messageCtrl);

    messageCtrl.$inject = ['$scope', '$route','meanData'];
    function messageCtrl($scope, $route, meanData) {

        var username;

        meanData.getProfile()
            .success(function (data) {
                $scope.messages = data.messages;
                username = data.username;
            })
            .error(function (error) {
                console.log(error);
            });

        $scope.deleteMessage = function (id) {
            meanData.deleteMessage(username, id)
                .success(function (data) {
                    $route.reload();
                    console.log(data.message);
                })
                .error(function (error) {
                    console.log(error);
                });
        }
    }

})();
(function() {

    angular
        .module('meanApp')
        .controller('profileCtrl', profileCtrl);

    profileCtrl.$inject = ['$scope', '$routeParams','$route', '$uibModal', 'meanData'];
    function profileCtrl($scope, $routeParams, $route, $uibModal, meanData) {

        var id = $routeParams.id;
        $scope.user = {};
        
        if(id){
            meanData.getProfileById(id)
                .success(function (data) {
                    $scope.user = data;
                })
                .error(function (err) {
                    console.log(err);
                })
                .then(function () {
                    meanData.getProfile()
                        .success(function (innerData) {
                            $scope.myUsername = innerData.username;
                            $scope.myProfile = innerData.username === $scope.user.username;
                        })
                        .error(function (err) {
                            console.log(err)
                        });
                });

        } else {
            meanData.getProfile()
                .success(function (data) {
                    $scope.user = data;
                    $scope.myProfile = true;
                })
                .error(function (e) {
                    console.log(e);
                });
        }
        
        $scope.open = function (size) {
            var modalInstance = $uibModal.open({
                animation: true,
                templateUrl: '/profile/profile/profile.message.modal.html',
                controller: 'ModalInstanceCtrl',
                size: size
            });

            modalInstance.result.then(function (message){
                meanData.sendMessage($scope.myUsername, $scope.user.username, message)
                    .error(function (err) {
                        console.log(err);
                    })
                    .then(function () {
                        console.log('Message sent correctly');
                    });
            });
        };
        
        $scope.addFriend = function () {
            meanData.addFriend($scope.myUsername, $scope.user.username)
                .error(function (err) {
                    console.log(err.error);
                    alert(err.error);
                })
                .then(function () {
                    alert('Friend request sent');
                    console.log('Friend Request sent');
                });
        };
        
        $scope.acceptFriend = function (friend) {
            meanData.acceptFriend(friend, $scope.user.username)
                .error(function (err) {
                    console.log(err);
                })
                .then(function () {
                    console.log('Friend request successfully accepted');
                    $route.reload();
                });
        };
        
        $scope.rejectFriend = function (friend) {
            meanData.rejectFriend(friend, $scope.user.username)
                .error(function (err) {
                    console.log(err);
                })
                .then(function () {
                    console.log('Friend request successfully rejected');
                    $route.reload();
                });
        };
        
        $scope.deleteFriend = function (friend) {
            meanData.deleteFriend(friend, $scope.user.username)
                .error(function (err) {
                    console.log(err);
                })
                .then(function () {
                    console.log('Friend successfully removed from list');
                    $route.reload();
                });
        }
    }

})();
(function () {

    angular
        .module('meanApp')
        .controller('ModalInstanceCtrl', ModalInstanceCtrl);

    ModalInstanceCtrl.$inject = ['$scope', '$uibModalInstance'];
    function ModalInstanceCtrl($scope, $uibModalInstance) {

        $scope.message;

        $scope.ok = function () {
            if($scope.message) {
                $uibModalInstance.close($scope.message);
            }
            else {
                $uibModalInstance.dismiss('cancel');
            }
        };

        $scope.cancel = function () {
            $uibModalInstance.dismiss('cancel');
        };
    }

})();
(function() {

    angular
        .module('meanApp')
        .controller('settingsCtrl', settingsCtrl);

    settingsCtrl.$inject = ['$scope', '$location', 'meanData'];
    function settingsCtrl($scope, $location, meanData) {
        var tempUser = {};
        $scope.passwords = {};
        $scope.email = "";

        meanData.getProfile()
            .success(function (data) {
                tempUser = data;
            })
            .error(function (error) {
                console.log(error);
            });

        $scope.onSubmitPass = function () {
            meanData.changePassword({passwords : $scope.passwords, user : tempUser})
                .success(function (data) {
                    console.log(data.message);
                    $location.path('/');
                })
                .error(function (err) {
                    alert(err.message);
                });
        };

        $scope.onSubmitEmail = function () {
            tempUser.email = $scope.email;
            meanData.changeEmail(tempUser)
                .success(function (data) {
                    console.log(data.message);
                    $location.path('/');
                })
                .error(function (err) {
                    alert(err.message);
                });
        };
    }

})();
(function () {

    angular
        .module('meanApp')
        .controller('navigationCtrl', navigationCtrl);

    navigationCtrl.$inject = ['$location', '$scope','authentication'];
    function navigationCtrl($location, $scope, authentication) {

        $scope.isLoggedIn = authentication.isLoggedIn();

        $scope.logout = function() {
            authentication.logout();
            $location.path('/');
        }
    }

})();
(function () {

    angular
        .module('meanApp')
        .directive('navigation', navigation);

    function navigation () {
        return {
            restrict: 'EA',
            templateUrl: '/common/directives/navigation/navigation.template.html',
            controller: 'navigationCtrl'
        };
    }

})();
(function () {

    angular
        .module('meanApp')
        .controller('sidebarCtrl', sidebarCtrl);

    sidebarCtrl.$inject = ['$scope','authentication'];
    function sidebarCtrl($scope, authentication) {
    }

})();
(function () {

    angular
        .module('meanApp')
        .directive('sidebar', sidebar);

    function sidebar () {
        return {
            restrict: 'EA',
            templateUrl: '/common/directives/sidebar/sidebar.template.html',
            controller: 'sidebarCtrl'
        };
    }

})();